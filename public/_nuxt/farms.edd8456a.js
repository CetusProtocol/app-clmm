import{a7 as W}from"./entry.4b03dc9c.js";import{u as Y,T as q,e as K,m as Q}from"./pool.d6b5ef6c.js";import{D as c}from"./decimal.0bdeb344.js";import{c as Z}from"./sha256.033d7784.js";const ro=W("farms",{state:()=>({farmsPoolList:[],farmsPoolObj:{},farmsPoolListLoading:!1,cmmPoolInfoObj:{},farmsPositionObj:{},farmsLoadingObj:{},farmsUserUsd:{},farmsRewardObj:{},farmsPositionList:[],farmsAllPositionLoading:!1,myFarmsPoolList:[]}),getters:{getPoolStore(){return Y()}},actions:{async getFarmsPoolList(P){P||(this.farmsPoolListLoading=!0);try{const{data:d}=await fetch(`${Z.Sui.api}/v2/sui/swap/count`).then(t=>t.json()),_=d.pools.filter(t=>t.stable_farming).map(t=>{var i,r,o;let x=0;const S=t.coin_a.decimals,l=t.coin_b.decimals,a=q.tickIndexToPrice(t.stable_farming.effective_tick_lower,S,l).toString(),m=q.tickIndexToPrice(t.stable_farming.effective_tick_upper,S,l).toString();let n=[];t.rewarder&&t.rewarder.rewarder_coin&&t.rewarder.rewarder_coin.length>0&&(n=(r=(i=t.rewarder)==null?void 0:i.rewarder_coin)==null?void 0:r.map((e,g)=>({...e,amountDay:new c(e.amount_second).mul(new c(60*60*24)).toNumber(),rewarder_display:t.rewarder[`rewarder_display${g+1}`],rewarderApr:e.apr.replace("%","")})));let u=!1;t.stable_farming&&t.stable_farming.stable_rewarder.map(e=>{e.amount_second>0&&(u=!0)});const w=[];t.stable_farming.stable_rewarder.forEach(e=>{x+=Number(e.amount_second),e.amount_second>0&&w.push({emission_per_day:new c(e.amount_second).mul(60*60*24),reward_coin:e.coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":e.coin,symbol:e.symbol,allocate_point:Number(e.amount_second)>0?1:0})});const f=t.apr_24h.replace("%",""),s=t.rewarder&&t.rewarder.apr.replace("%","")||0;return{...t,clmm_pool_id:t.swap_account,effective_tick_lower:t.stable_farming.effective_tick_lower,effective_tick_upper:t.stable_farming.effective_tick_upper,fee:t.fee*100+"%",id:t.stable_farming.stable_farming_pool,rewarders:w,status:x>0?"Live":"Ended",minPrice:a,maxPrice:m,coinA:t.coin_a,coinB:t.coin_b,stableFarmingApr:t.stable_farming&&t.stable_farming.apr*100,rewarder:{...t.rewarder,rewardList:n},isStableFarming:u,is_display_rewarder:(o=t==null?void 0:t.rewarder)==null?void 0:o.is_display_rewarder,aprTotal:Number(f)+Number(s),apr:t.apr_24h.replace("%",""),clmmApr:Number(f)+Number(s)}});this.farmsPoolList=_,this.farmsPoolObj=Object.fromEntries(_.map(t=>[t.clmm_pool_id,{...t,address:t.clmm_pool_id}])),this.farmsPoolListLoading=!1}catch{const _=await K("Sui").getLpList(),t=Object.fromEntries(_.map((a,m)=>[a.address,a])),l=(await Q("Sui").getFramsPoolList()).map(a=>{const m=t[a.clmm_pool_id];let n=0;const{tokensObj:u}=this.getPoolStore,w=a.rewarders.map(o=>{const e=o.reward_coin=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":o.reward_coin,g=u[e].decimals,p=u[e].symbol;n=n+Number(o.allocate_point);const A=new c(o.allocate_point).div(new c(o.total_allocate_point));return{...o,reward_coin:e,emission_per_day:Number(o.allocate_point)>0?new c(o.emission_per_second).mul(A).div(Math.pow(10,12)).mul(60*60*24).div(Math.pow(10,g)).toString():"0",symbol:p}}),f=m.coinA.decimals,s=m.coinB.decimals,i=q.tickIndexToPrice(a.effective_tick_lower,f,s).toString(),r=q.tickIndexToPrice(a.effective_tick_upper,f,s).toString();return{...a,minPrice:i,maxPrice:r,fee:m.fee*100+"%",coinA:m.coinA,coinB:m.coinB,rewarders:w,status:n>0?"Live":"Ended",stable_farming:{apr:0,tvl:0},coin_a:m.coinA,coin_b:m.coinB}});this.farmsPoolList=l,this.farmsPoolObj=Object.fromEntries(l.map(a=>[a.clmm_pool_id,{...a,address:a.clmm_pool_id}])),this.cmmPoolInfoObj=t,this.farmsPoolListLoading=!1}},async getPositionByPool(P,d,b){var s,i;this.farmsLoadingObj[d]=!0;const _=K("Sui"),S=(await Q("Sui").getOwnedFramsPositionNFTList(!0)).filter(r=>r.clmm_pool_id==d),l=await _.getPositionList(P,{address:{address:d}})||[],a=S.concat(l),m={},n={},u=[];for(let r=0;r<a.length;r++){const o=a[r],e=this.farmsPoolObj[o.clmm_pool_id||o.pool],g=e.coinA.decimals,p=e.coinB.decimals;let A,O;o.tick_lower_index==_.TickUtil.getMinIndex(Number(e.tick_spacing))?A="0":A=_.TickMath.tickIndexToPrice(Number(o.tick_lower_index),g,p).toString(),o.tick_upper_index==_.TickUtil.getMaxIndex(Number(e.tick_spacing))?O="∞":O=_.TickMath.tickIndexToPrice(Number(o.tick_upper_index),g,p).toString();let j;const U=await _.getPool(o.clmm_pool_id||o.pool),M=q.sqrtPriceX64ToPrice(U.current_sqrt_price,g,p).toString();Number(M)>=Number(A)&&(O==="∞"||Number(M)<=Number(O))?j="Active":(Number(M)>Number(O)||Number(M)<Number(A))&&(j="Inactive");const E=_.getCoinAmountFromLiquidity({pool:U,position:o,roundUp:!1}),{RATES:v,tokensObj:I}=this.getPoolStore,T=((s=v[e.coin_a.address])==null?void 0:s.price)||"",L=((i=v[e.coin_a.address])==null?void 0:i.price)||"",F=new c(E.coinaAmount).div(Math.pow(10,g)),R=new c(E.coinbAmount).div(Math.pow(10,p)),D=new c(E.coinaAmount).div(Math.pow(10,g)).mul(T),k=new c(E.coinbAmount).div(Math.pow(10,p)).mul(L);let y=new c(0);const C=this.farmsPoolObj[o.clmm_pool_id],N=[];o.rewards&&o.rewards.length>0?(o.rewards.forEach((h,J)=>{var V;const G=h.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":h.rewarder_type,z=I[G],B=((V=v[G])==null?void 0:V.price)||0,X=new c(h.rewarder_amount).div(new c(Math.pow(10,z.decimals))),$=X.mul(new c(B));n[o.clmm_pool_id]&&n[o.clmm_pool_id][o.id]?n[o.clmm_pool_id][o.id]=n[o.clmm_pool_id][o.id].add($):n[o.clmm_pool_id]&&!n[o.clmm_pool_id][o.id]?(n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$):(n[o.clmm_pool_id]={},n[o.clmm_pool_id][o.id]={},n[o.clmm_pool_id][o.id]=$),y=y.add($),(C.rewarders[J]||h.rewarder_amount>0)&&N.push({...h,rewarderAmount:X.toString(),rewarderAmountUsd:$.toString(),rewarderType:G})}),o.rewards=N):(o.rewards=[],this.farmsRewardObj[o.clmm_pool_id]={});let H;if(o.id){const h=D.add(k);m[o.clmm_pool_id]||(m[o.clmm_pool_id]={}),m[o.clmm_pool_id][o.id]=h}u.push({...o,minPrice:A,maxPrice:O,positionUSD:D.add(k).toNumber(),clmmPool:o.clmm_pool_id||o.pool,positionStatus:j,positionSource:o.creator?"clmm":"farming",farmsPoolId:b,coinA:e.coinA,coinB:e.coinB,positionShare:H,amountAUsd:D,amountBUsd:k,amountA:F,amountB:R,positionRewardAmount:y})}const w={};Object.keys(n).forEach(r=>{w[r]={},w[r].amountUsd=new c(0),typeof n[r]=="object"&&Object.keys(n[r]).forEach(o=>{w[r].amountUsd=w[r].amountUsd.add(n[r][o])})});const f={};Object.keys(m).forEach(r=>{f[r]={},f[r].amount=new c(0),f[r].positionNum=0,typeof m[r]=="object"&&Object.keys(m[r]).forEach(o=>{f[r].amount=f[r].amount.add(m[r][o]),f[r].positionNum+=1})}),this.farmsRewardObj[d]={},this.farmsRewardObj={...this.farmsRewardObj,...w},this.farmsUserUsd[d]={},this.farmsUserUsd={...this.farmsUserUsd,...f},this.farmsPositionObj[d]=u,this.farmsLoadingObj[d]=!1,this.getMyFarms()},async getPositionByAllPool(P){var w,f;this.farmsAllPositionLoading=!0;const d=Q("Sui"),b=K("Sui"),_=await d.getOwnedFramsPositionNFTList(!0),t=await b.getPositionList(P,this.farmsPoolObj)||[],x=_.concat(t),S=[],l={},a={};for(let s=0;s<x.length;s++){const i=x[s],r=await b.getPool(i.clmm_pool_id||i.pool),o=b.getCoinAmountFromLiquidity({pool:r,position:i,roundUp:!1}),{RATES:e,tokensObj:g}=this.getPoolStore,p=this.farmsPoolObj[i.clmm_pool_id||i.pool],A=((w=e[p.coin_a.address])==null?void 0:w.price)||"",O=((f=e[p.coin_b.address])==null?void 0:f.price)||"",j=p.coin_a.decimals,U=p.coin_b.decimals,M=new c(o.coinaAmount).div(Math.pow(10,j)),E=new c(o.coinbAmount).div(Math.pow(10,U)),v=new c(o.coinaAmount).div(Math.pow(10,j)).mul(A),I=new c(o.coinbAmount).div(Math.pow(10,U)).mul(O);let T,L;i.tick_lower_index==b.TickUtil.getMinIndex(Number(p.tick_spacing))?T="0":T=b.TickMath.tickIndexToPrice(Number(i.tick_lower_index),j,U).toString(),i.tick_upper_index==b.TickUtil.getMaxIndex(Number(p.tick_spacing))?L="∞":L=b.TickMath.tickIndexToPrice(Number(i.tick_upper_index),j,U).toString();let F;const R=q.sqrtPriceX64ToPrice(r.current_sqrt_price,j,U).toString();Number(R)>=Number(T)&&(L==="∞"||Number(R)<=Number(L))?F="Active":(Number(R)>Number(L)||Number(R)<Number(T))&&(F="Inactive");let D;if(i.id){const C=v.add(I);a[i.clmm_pool_id]||(a[i.clmm_pool_id]={}),a[i.clmm_pool_id][i.id]=C}let k=new c(0);const y=[];if(i.rewards&&i.rewards.length>0){const C=this.farmsPoolObj[i.clmm_pool_id];i.rewards.forEach((N,H)=>{var X;const h=N.rewarder_type=="0x0000000000000000000000000000000000000000000000000000000000000002::sui::SUI"?"0x2::sui::SUI":N.rewarder_type,J=g[h],G=((X=e[h])==null?void 0:X.price)||0,z=new c(N.rewarder_amount).div(new c(Math.pow(10,J.decimals))),B=z.mul(new c(G));l[i.clmm_pool_id]&&l[i.clmm_pool_id][i.id]?l[i.clmm_pool_id][i.id]=l[i.clmm_pool_id][i.id].add(B):l[i.clmm_pool_id]&&!l[i.clmm_pool_id][i.id]?(l[i.clmm_pool_id][i.id]={},l[i.clmm_pool_id][i.id]=B):(l[i.clmm_pool_id]={},l[i.clmm_pool_id][i.id]={},l[i.clmm_pool_id][i.id]=B),k=k.add(B),(C.rewarders[H]||N.rewarder_amount>0)&&y.push({...N,rewarderAmount:z.toString(),rewarderAmountUsd:B.toString(),rewarderType:h})}),i.rewards=y}else i.rewards=[],this.farmsRewardObj[i.clmm_pool_id]={};S.push({...i,minPrice:T,maxPrice:L,positionUSD:v.add(I).toNumber(),clmmPool:i.clmm_pool_id||i.pool,positionStatus:F,positionSource:i.creator?"clmm":"farming",farmsPoolId:i.pool_id,coinA:p.coinA,coinB:p.coinB,soucrce:i.id?"farming":"clmm",positionShare:D,amountAUsd:v.toString(),amountBUsd:I.toString(),amountA:M.toString(),amountB:E.toString(),positionRewardAmount:k})}this.farmsPositionList=S;const m={};S.forEach(s=>{m[s.clmm_pool_id||s.pool]||(m[s.clmm_pool_id||s.pool]=[]),m[s.clmm_pool_id||s.pool].push(s)}),this.farmsPositionObj=m,this.farmsAllPositionLoading=!1;const n={};Object.keys(l).forEach(s=>{n[s]={},n[s].amountUsd=new c(0),typeof l[s]=="object"&&Object.keys(l[s]).forEach(i=>{n[s].amountUsd=n[s].amountUsd.add(l[s][i])})});const u={};Object.keys(a).forEach(s=>{u[s]={},u[s].amount=new c(0),u[s].positionNum=0,typeof a[s]=="object"&&Object.keys(a[s]).forEach(i=>{u[s].amount=u[s].amount.add(a[s][i]),u[s].positionNum+=1})}),this.farmsRewardObj=n,this.farmsUserUsd=u,this.getMyFarms()},getMyFarms(){const P=[];this.farmsPoolList.forEach(d=>{const b=this.farmsPositionObj[d.clmm_pool_id]&&this.farmsPositionObj[d.clmm_pool_id].filter(_=>_.positionSource=="farming");b&&b.length>0&&P.push(d)}),this.myFarmsPoolList=P},setFarmsLoadingObj(P){this.farmsLoadingObj[P]=!0},logOut(){this.farmsPositionObj={},this.farmsUserUsd={},this.farmsRewardObj={},this.farmsPositionList=[],this.farmsAllPositionLoading=!1,this.myFarmsPoolList=[]}}});export{ro as u};
